import { __assign, __decorate, __metadata, __rest } from "tslib";
import { Component, ViewChild, ElementRef, EventEmitter, Input, ChangeDetectionStrategy, forwardRef, Output } from '@angular/core';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
import { filter, take } from 'rxjs/operators';
import { MonacoEditorLoaderService } from '../../services/monaco-editor-loader.service';
var MonacoEditorComponent = /** @class */ (function () {
    function MonacoEditorComponent(monacoLoader) {
        this.monacoLoader = monacoLoader;
        this.init = new EventEmitter();
        this.propagateChange = function (_) { };
    }
    MonacoEditorComponent_1 = MonacoEditorComponent;
    Object.defineProperty(MonacoEditorComponent.prototype, "model", {
        get: function () {
            return this.editor && this.editor.getModel();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MonacoEditorComponent.prototype, "modelMarkers", {
        get: function () {
            return this.model && monaco.editor.getModelMarkers({
                resource: this.model.uri
            });
        },
        enumerable: true,
        configurable: true
    });
    MonacoEditorComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.monacoLoader.isMonacoLoaded$.pipe(filter(function (isLoaded) { return isLoaded; }), take(1)).subscribe(function () {
            _this.initEditor();
        });
    };
    MonacoEditorComponent.prototype.ngOnChanges = function (changes) {
        if (this.editor && changes.options && !changes.options.firstChange) {
            var _a = changes.options.currentValue, toLanguage = _a.language, toTheme = _a.theme, options = __rest(_a, ["language", "theme"]);
            var _b = changes.options.previousValue, fromLanguage = _b.language, fromTheme = _b.theme;
            if (fromLanguage !== toLanguage) {
                monaco.editor.setModelLanguage(this.editor.getModel(), this.options && this.options.language ? this.options.language : 'text');
            }
            if (fromTheme !== toTheme) {
                monaco.editor.setTheme(toTheme);
            }
            this.editor.updateOptions(options);
        }
        if (this.editor && changes.uri) {
            var toUri_1 = changes.uri.currentValue;
            var fromUri = changes.uri.previousValue;
            if (fromUri && !toUri_1 || !fromUri && toUri_1 || toUri_1 && fromUri && toUri_1.path !== fromUri.path) {
                var value = this.editor.getValue();
                if (this.modelUriInstance) {
                    this.modelUriInstance.dispose();
                }
                var existingModel = void 0;
                if (toUri_1) {
                    existingModel = monaco.editor.getModels().find(function (model) { return model.uri.path === toUri_1.path; });
                }
                this.modelUriInstance = existingModel ? existingModel : monaco.editor.createModel(value, this.options.language || 'text', this.uri);
                this.editor.setModel(this.modelUriInstance);
            }
        }
    };
    MonacoEditorComponent.prototype.writeValue = function (value) {
        this.value = value;
        if (this.editor && value) {
            this.editor.setValue(value);
        }
        else if (this.editor) {
            this.editor.setValue('');
        }
    };
    MonacoEditorComponent.prototype.registerOnChange = function (fn) {
        this.propagateChange = fn;
    };
    MonacoEditorComponent.prototype.registerOnTouched = function (fn) {
        this.onTouched = fn;
    };
    MonacoEditorComponent.prototype.validate = function () {
        return !this.parsedError ? null : {
            monaco: {
                value: this.parsedError.split('|'),
            }
        };
    };
    MonacoEditorComponent.prototype.registerOnValidatorChange = function (fn) {
        this.onErrorStatusChange = fn;
    };
    MonacoEditorComponent.prototype.initEditor = function () {
        var options = {
            value: [this.value].join('\n'),
            language: 'text',
            automaticLayout: true,
            scrollBeyondLastLine: false,
            theme: 'vc'
        };
        this.editor = monaco.editor.create(this.editorContent.nativeElement, this.options ? __assign(__assign({}, options), this.options) : options);
        this.registerEditorListeners();
        this.init.emit(this.editor);
    };
    MonacoEditorComponent.prototype.registerEditorListeners = function () {
        var _this = this;
        this.editor.onDidChangeModelContent(function () {
            _this.propagateChange(_this.editor.getValue());
        });
        this.editor.onDidChangeModelDecorations(function () {
            var currentParsedError = _this.modelMarkers.map(function (_a) {
                var message = _a.message;
                return message;
            }).join('|');
            var hasValidationStatusChanged = _this.parsedError !== currentParsedError;
            if (hasValidationStatusChanged) {
                _this.parsedError = currentParsedError;
                _this.onErrorStatusChange();
            }
        });
        this.editor.onDidBlurEditorText(function () {
            _this.onTouched();
        });
    };
    MonacoEditorComponent.prototype.ngOnDestroy = function () {
        if (this.editor) {
            this.editor.dispose();
        }
    };
    var MonacoEditorComponent_1;
    MonacoEditorComponent.ctorParameters = function () { return [
        { type: MonacoEditorLoaderService }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], MonacoEditorComponent.prototype, "options", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], MonacoEditorComponent.prototype, "uri", void 0);
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], MonacoEditorComponent.prototype, "init", void 0);
    __decorate([
        ViewChild('editor', { static: true }),
        __metadata("design:type", ElementRef)
    ], MonacoEditorComponent.prototype, "editorContent", void 0);
    MonacoEditorComponent = MonacoEditorComponent_1 = __decorate([
        Component({
            selector: 'ngx-monaco-editor',
            template: "<div #container class=\"editor-container\" fxFlex>\n\t\t<div\n\t\t\t#editor\n\t\t\tclass=\"monaco-editor\"\n\t\t></div>\n</div>",
            changeDetection: ChangeDetectionStrategy.OnPush,
            providers: [
                {
                    provide: NG_VALUE_ACCESSOR,
                    useExisting: forwardRef(function () { return MonacoEditorComponent_1; }),
                    multi: true
                },
                {
                    provide: NG_VALIDATORS,
                    useExisting: forwardRef(function () { return MonacoEditorComponent_1; }),
                    multi: true,
                }
            ],
            styles: ["\n.monaco-editor {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n\n}\n.editor-container {\n\toverflow: hidden;\n\tposition: relative;\n\tdisplay: table;\n\twidth: 100%;\n  height: 100%;\n  min-width: 0;\n}"]
        }),
        __metadata("design:paramtypes", [MonacoEditorLoaderService])
    ], MonacoEditorComponent);
    return MonacoEditorComponent;
}());
export { MonacoEditorComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uYWNvLWVkaXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbWF0ZXJpYS11aS9uZ3gtbW9uYWNvLWVkaXRvci8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL21vbmFjby1lZGl0b3IvbW9uYWNvLWVkaXRvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBSVosS0FBSyxFQUNMLHVCQUF1QixFQUN2QixVQUFVLEVBRVYsTUFBTSxFQUNULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBd0IsaUJBQWlCLEVBQWEsYUFBYSxFQUFvQixNQUFNLGdCQUFnQixDQUFDO0FBQ3JILE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUMsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUE0Q3hGO0lBeUJJLCtCQUFvQixZQUF1QztRQUF2QyxpQkFBWSxHQUFaLFlBQVksQ0FBMkI7UUF0QmpELFNBQUksR0FBNkMsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQVV0RSxvQkFBZSxHQUFvQixVQUFDLENBQU0sSUFBTyxDQUFDLENBQUM7SUFZSSxDQUFDOzhCQXpCdkQscUJBQXFCO0lBZTlCLHNCQUFJLHdDQUFLO2FBQVQ7WUFDRSxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMvQyxDQUFDOzs7T0FBQTtJQUVELHNCQUFJLCtDQUFZO2FBQWhCO1lBQ0UsT0FBTyxJQUFJLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO2dCQUNqRCxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHO2FBQ3pCLENBQUMsQ0FBQztRQUNMLENBQUM7OztPQUFBO0lBSUQsd0NBQVEsR0FB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QUU7O3NEQUF1QjtJQUNyQjtRQUFULE1BQU0sRUFBRTtrQ0FBTyxZQUFZO3VEQUFrRDtJQUN6QztRQUFwQyxTQUFTLENBQUMsUUFBUSxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDO2tDQUFnQixVQUFVO2dFQUFDO0lBSnRELHFCQUFxQjtRQXpDakMsU0FBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLG1CQUFtQjtZQUM3QixRQUFRLEVBQUUsaUlBS1A7WUFvQkgsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07WUFDL0MsU0FBUyxFQUFFO2dCQUNQO29CQUNJLE9BQU8sRUFBRSxpQkFBaUI7b0JBQzFCLFdBQVcsRUFBRSxVQUFVLENBQUMsY0FBTSxPQUFBLHVCQUFxQixFQUFyQixDQUFxQixDQUFDO29CQUNwRCxLQUFLLEVBQUUsSUFBSTtpQkFDZDtnQkFDRDtvQkFDSSxPQUFPLEVBQUUsYUFBYTtvQkFDdEIsV0FBVyxFQUFFLFVBQVUsQ0FBQyxjQUFNLE9BQUEsdUJBQXFCLEVBQXJCLENBQXFCLENBQUM7b0JBQ3BELEtBQUssRUFBRSxJQUFJO2lCQUNkO2FBQ0o7cUJBOUJHLDJPQWdCTjtTQWVELENBQUM7eUNBMEJvQyx5QkFBeUI7T0F6QmxELHFCQUFxQixDQTZJakM7SUFBRCw0QkFBQztDQUFBLEFBN0lELElBNklDO1NBN0lZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ29tcG9uZW50LFxuICAgIFZpZXdDaGlsZCxcbiAgICBFbGVtZW50UmVmLFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBPbkluaXQsXG4gICAgT25DaGFuZ2VzLFxuICAgIE9uRGVzdHJveSxcbiAgICBJbnB1dCxcbiAgICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgICBmb3J3YXJkUmVmLFxuICAgIFNpbXBsZUNoYW5nZXMsXG4gICAgT3V0cHV0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SLCBWYWxpZGF0b3IsIE5HX1ZBTElEQVRPUlMsIFZhbGlkYXRpb25FcnJvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IE1vbmFjb0VkaXRvckxvYWRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9tb25hY28tZWRpdG9yLWxvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IE1vbmFjb0VkaXRvckNvbnN0cnVjdGlvbk9wdGlvbnMsIE1vbmFjb0VkaXRvclVyaSwgTW9uYWNvU3RhbmRhbG9uZUNvZGVFZGl0b3IgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICduZ3gtbW9uYWNvLWVkaXRvcicsXG4gICAgdGVtcGxhdGU6IGA8ZGl2ICNjb250YWluZXIgY2xhc3M9XCJlZGl0b3ItY29udGFpbmVyXCIgZnhGbGV4PlxuXHRcdDxkaXZcblx0XHRcdCNlZGl0b3Jcblx0XHRcdGNsYXNzPVwibW9uYWNvLWVkaXRvclwiXG5cdFx0PjwvZGl2PlxuPC9kaXY+YCxcbiAgICBzdHlsZXM6IFtcbiAgICAgICAgYFxuLm1vbmFjby1lZGl0b3Ige1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIHRvcDogMDtcbiAgYm90dG9tOiAwO1xuICBsZWZ0OiAwO1xuICByaWdodDogMDtcblxufVxuLmVkaXRvci1jb250YWluZXIge1xuXHRvdmVyZmxvdzogaGlkZGVuO1xuXHRwb3NpdGlvbjogcmVsYXRpdmU7XG5cdGRpc3BsYXk6IHRhYmxlO1xuXHR3aWR0aDogMTAwJTtcbiAgaGVpZ2h0OiAxMDAlO1xuICBtaW4td2lkdGg6IDA7XG59YFxuICAgIF0sXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgICAgICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTW9uYWNvRWRpdG9yQ29tcG9uZW50KSxcbiAgICAgICAgICAgIG11bHRpOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIHByb3ZpZGU6IE5HX1ZBTElEQVRPUlMsXG4gICAgICAgICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBNb25hY29FZGl0b3JDb21wb25lbnQpLFxuICAgICAgICAgICAgbXVsdGk6IHRydWUsXG4gICAgICAgIH1cbiAgICBdXG59KVxuZXhwb3J0IGNsYXNzIE1vbmFjb0VkaXRvckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBWYWxpZGF0b3Ige1xuICAgIEBJbnB1dCgpIG9wdGlvbnM6IE1vbmFjb0VkaXRvckNvbnN0cnVjdGlvbk9wdGlvbnM7XG4gICAgQElucHV0KCkgdXJpPzogTW9uYWNvRWRpdG9yVXJpO1xuICAgIEBPdXRwdXQoKSBpbml0OiBFdmVudEVtaXR0ZXI8TW9uYWNvU3RhbmRhbG9uZUNvZGVFZGl0b3I+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIEBWaWV3Q2hpbGQoJ2VkaXRvcicsIHtzdGF0aWM6IHRydWV9KSBlZGl0b3JDb250ZW50OiBFbGVtZW50UmVmO1xuXG4gICAgZWRpdG9yOiBNb25hY29TdGFuZGFsb25lQ29kZUVkaXRvcjtcbiAgICBtb2RlbFVyaUluc3RhbmNlOiBtb25hY28uZWRpdG9yLklUZXh0TW9kZWw7XG4gICAgdmFsdWU6IHN0cmluZztcbiAgICBwYXJzZWRFcnJvcjogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBvblRvdWNoZWQ6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBvbkVycm9yU3RhdHVzQ2hhbmdlOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgcHJvcGFnYXRlQ2hhbmdlOiAoXzogYW55KSA9PiBhbnkgPSAoXzogYW55KSA9PiB7IH07XG5cbiAgICBnZXQgbW9kZWwoKSB7XG4gICAgICByZXR1cm4gdGhpcy5lZGl0b3IgJiYgdGhpcy5lZGl0b3IuZ2V0TW9kZWwoKTtcbiAgICB9XG5cbiAgICBnZXQgbW9kZWxNYXJrZXJzKCkge1xuICAgICAgcmV0dXJuIHRoaXMubW9kZWwgJiYgbW9uYWNvLmVkaXRvci5nZXRNb2RlbE1hcmtlcnMoe1xuICAgICAgICByZXNvdXJjZTogdGhpcy5tb2RlbC51cmlcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbW9uYWNvTG9hZGVyOiBNb25hY29FZGl0b3JMb2FkZXJTZXJ2aWNlKSB7IH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLm1vbmFjb0xvYWRlci5pc01vbmFjb0xvYWRlZCQucGlwZShcbiAgICAgICAgICAgIGZpbHRlcihpc0xvYWRlZCA9PiBpc0xvYWRlZCksXG4gICAgICAgICAgICB0YWtlKDEpXG4gICAgICAgICkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaW5pdEVkaXRvcigpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGlmICh0aGlzLmVkaXRvciAmJiBjaGFuZ2VzLm9wdGlvbnMgJiYgIWNoYW5nZXMub3B0aW9ucy5maXJzdENoYW5nZSkge1xuICAgICAgICAgIGNvbnN0IHsgbGFuZ3VhZ2U6IHRvTGFuZ3VhZ2UsIHRoZW1lOiB0b1RoZW1lLCAuLi5vcHRpb25zIH0gPSBjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlO1xuICAgICAgICAgIGNvbnN0IHsgbGFuZ3VhZ2U6IGZyb21MYW5ndWFnZSwgdGhlbWU6IGZyb21UaGVtZSB9ID0gY2hhbmdlcy5vcHRpb25zLnByZXZpb3VzVmFsdWU7XG4gICAgICAgICAgICBpZiAoZnJvbUxhbmd1YWdlICE9PSB0b0xhbmd1YWdlKSB7XG4gICAgICAgICAgICAgICAgbW9uYWNvLmVkaXRvci5zZXRNb2RlbExhbmd1YWdlKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5nZXRNb2RlbCgpLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMgJiYgdGhpcy5vcHRpb25zLmxhbmd1YWdlID8gdGhpcy5vcHRpb25zLmxhbmd1YWdlIDogJ3RleHQnXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChmcm9tVGhlbWUgIT09IHRvVGhlbWUpIHtcbiAgICAgICAgICAgICAgICBtb25hY28uZWRpdG9yLnNldFRoZW1lKHRvVGhlbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5lZGl0b3IudXBkYXRlT3B0aW9ucyhvcHRpb25zKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5lZGl0b3IgJiYgY2hhbmdlcy51cmkpIHtcbiAgICAgICAgICBjb25zdCB0b1VyaSA9IGNoYW5nZXMudXJpLmN1cnJlbnRWYWx1ZTtcbiAgICAgICAgICBjb25zdCBmcm9tVXJpID0gY2hhbmdlcy51cmkucHJldmlvdXNWYWx1ZTtcbiAgICAgICAgICBpZiAoZnJvbVVyaSAmJiAhdG9VcmkgfHwgIWZyb21VcmkgJiYgdG9VcmkgfHwgdG9VcmkgJiYgZnJvbVVyaSAmJiB0b1VyaS5wYXRoICE9PSBmcm9tVXJpLnBhdGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5lZGl0b3IuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsVXJpSW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgdGhpcy5tb2RlbFVyaUluc3RhbmNlLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBleGlzdGluZ01vZGVsO1xuICAgICAgICAgICAgaWYgKHRvVXJpKSB7XG4gICAgICAgICAgICAgIGV4aXN0aW5nTW9kZWwgPSBtb25hY28uZWRpdG9yLmdldE1vZGVscygpLmZpbmQoKG1vZGVsKSA9PiBtb2RlbC51cmkucGF0aCA9PT0gdG9VcmkucGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLm1vZGVsVXJpSW5zdGFuY2UgPSBleGlzdGluZ01vZGVsID8gZXhpc3RpbmdNb2RlbCA6IG1vbmFjby5lZGl0b3IuY3JlYXRlTW9kZWwodmFsdWUsIHRoaXMub3B0aW9ucy5sYW5ndWFnZSB8fCAndGV4dCcsIHRoaXMudXJpKTtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldE1vZGVsKHRoaXMubW9kZWxVcmlJbnN0YW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgd3JpdGVWYWx1ZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgaWYgKHRoaXMuZWRpdG9yICYmIHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRWYWx1ZSh2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5lZGl0b3IpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldFZhbHVlKCcnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb3BhZ2F0ZUNoYW5nZSA9IGZuO1xuICAgIH1cblxuICAgIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcbiAgICB9XG5cbiAgICB2YWxpZGF0ZSgpOiBWYWxpZGF0aW9uRXJyb3JzIHtcbiAgICAgICAgcmV0dXJuICF0aGlzLnBhcnNlZEVycm9yID8gbnVsbCA6IHtcbiAgICAgICAgICAgIG1vbmFjbzoge1xuICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnBhcnNlZEVycm9yLnNwbGl0KCd8JyksXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcmVnaXN0ZXJPblZhbGlkYXRvckNoYW5nZT8oZm46ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5vbkVycm9yU3RhdHVzQ2hhbmdlID0gZm47XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RWRpdG9yKCkge1xuICAgICAgICBjb25zdCBvcHRpb25zOiBNb25hY29FZGl0b3JDb25zdHJ1Y3Rpb25PcHRpb25zID0ge1xuICAgICAgICAgICAgdmFsdWU6IFt0aGlzLnZhbHVlXS5qb2luKCdcXG4nKSxcbiAgICAgICAgICAgIGxhbmd1YWdlOiAndGV4dCcsXG4gICAgICAgICAgICBhdXRvbWF0aWNMYXlvdXQ6IHRydWUsXG4gICAgICAgICAgICBzY3JvbGxCZXlvbmRMYXN0TGluZTogZmFsc2UsXG4gICAgICAgICAgICB0aGVtZTogJ3ZjJ1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuZWRpdG9yID0gbW9uYWNvLmVkaXRvci5jcmVhdGUoXG4gICAgICAgICAgdGhpcy5lZGl0b3JDb250ZW50Lm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgICAgdGhpcy5vcHRpb25zID8geyAuLi5vcHRpb25zLCAuLi50aGlzLm9wdGlvbnMgfSA6IG9wdGlvbnNcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLnJlZ2lzdGVyRWRpdG9yTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuaW5pdC5lbWl0KHRoaXMuZWRpdG9yKTtcbiAgICB9XG5cbiAgICByZWdpc3RlckVkaXRvckxpc3RlbmVycygpIHtcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkQ2hhbmdlTW9kZWxDb250ZW50KCgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9wYWdhdGVDaGFuZ2UodGhpcy5lZGl0b3IuZ2V0VmFsdWUoKSk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRDaGFuZ2VNb2RlbERlY29yYXRpb25zKCgpID0+IHtcbiAgICAgICAgICBjb25zdCBjdXJyZW50UGFyc2VkRXJyb3IgPSB0aGlzLm1vZGVsTWFya2Vycy5tYXAoKHsgbWVzc2FnZSB9KSA9PiBtZXNzYWdlKS5qb2luKCd8Jyk7XG4gICAgICAgICAgY29uc3QgaGFzVmFsaWRhdGlvblN0YXR1c0NoYW5nZWQgPSB0aGlzLnBhcnNlZEVycm9yICE9PSBjdXJyZW50UGFyc2VkRXJyb3I7XG5cbiAgICAgICAgICBpZiAoaGFzVmFsaWRhdGlvblN0YXR1c0NoYW5nZWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5wYXJzZWRFcnJvciA9IGN1cnJlbnRQYXJzZWRFcnJvcjtcbiAgICAgICAgICAgICAgdGhpcy5vbkVycm9yU3RhdHVzQ2hhbmdlKCk7XG4gICAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkQmx1ckVkaXRvclRleHQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMub25Ub3VjaGVkKCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgaWYgKHRoaXMuZWRpdG9yKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=